<svg xmlns="http://www.w3.org/2000/svg" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="481px"
     preserveAspectRatio="none" style="width:689px;height:481px;background:#FFFFFF;" version="1.1" viewBox="0 0 689 481"
     width="689px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="105.2422" style="stroke:#000000;stroke-width:1.5;" width="449.2275" x="233.939" y="294.3516"/><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="409.416" width="8" x="27.7524" y="36.4883"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="31" x2="31" y1="36.4883" y2="445.9043"/></g><g><title>ConsensusEngine</title><rect fill="#000000" fill-opacity="0.00000" height="409.416" width="8" x="306.4902" y="36.4883"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="309.939" x2="309.939" y1="36.4883" y2="445.9043"/></g><g><title>StateMachine</title><rect fill="#000000" fill-opacity="0.00000" height="409.416" width="8" x="517.02" y="36.4883"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="520.1558" x2="520.1558" y1="36.4883" y2="445.9043"/></g><g><title>Persistence</title><rect fill="#000000" fill-opacity="0.00000" height="409.416" width="8" x="624.0254" y="36.4883"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="627.8843" x2="627.8843" y1="36.4883" y2="445.9043"/></g><g class="participant participant-head" data-participant="Client"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="53.5049" x="5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39.5049" x="12" y="25.5352">Client</text></g><g class="participant participant-tail" data-participant="Client"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="53.5049" x="5" y="444.9043"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39.5049" x="12" y="465.4395">Client</text></g><g class="participant participant-head" data-participant="ConsensusEngine"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="133.1025" x="243.939" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="119.1025" x="250.939" y="25.5352">ConsensusEngine</text></g><g class="participant participant-tail" data-participant="ConsensusEngine"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="133.1025" x="243.939" y="444.9043"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="119.1025" x="250.939" y="465.4395">ConsensusEngine</text></g><g class="participant participant-head" data-participant="StateMachine"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="103.7285" x="469.1558" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89.7285" x="476.1558" y="25.5352">StateMachine</text></g><g class="participant participant-tail" data-participant="StateMachine"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="103.7285" x="469.1558" y="444.9043"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89.7285" x="476.1558" y="465.4395">StateMachine</text></g><g class="participant participant-head" data-participant="Persistence"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="90.2822" x="582.8843" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76.2822" x="589.8843" y="25.5352">Persistence</text></g><g class="participant participant-tail" data-participant="Persistence"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="90.2822" x="582.8843" y="444.9043"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76.2822" x="589.8843" y="465.4395">Persistence</text></g><g class="message" data-participant-1="Client" data-participant-2="ConsensusEngine"><line style="stroke:#181818;stroke-width:1;" x1="308.4902" x2="298.4902" y1="67.7988" y2="63.7988"/><line style="stroke:#181818;stroke-width:1;" x1="308.4902" x2="298.4902" y1="67.7988" y2="71.7988"/><line style="stroke:#181818;stroke-width:1;" x1="31.7524" x2="309.4902" y1="67.7988" y2="67.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254.7378" x="38.7524" y="63.0566">apply(commands) &#8594; Promise&lt;List&lt;R&gt;&gt;</text></g><g class="message" data-participant-1="ConsensusEngine" data-participant-2="ConsensusEngine"><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="352.4902" y1="97.1094" y2="97.1094"/><line style="stroke:#181818;stroke-width:1;" x1="352.4902" x2="352.4902" y1="97.1094" y2="110.1094"/><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="352.4902" y1="110.1094" y2="110.1094"/><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="110.1094" y2="106.1094"/><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="110.1094" y2="114.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196.5298" x="317.4902" y="92.3672">Create Batch with CorrelationId</text></g><g class="message" data-participant-1="ConsensusEngine" data-participant-2="ConsensusEngine"><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="352.4902" y1="139.4199" y2="139.4199"/><line style="stroke:#181818;stroke-width:1;" x1="352.4902" x2="352.4902" y1="139.4199" y2="152.4199"/><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="352.4902" y1="152.4199" y2="152.4199"/><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="152.4199" y2="148.4199"/><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="152.4199" y2="156.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142.5811" x="317.4902" y="134.6777">Track batch &amp; promise</text></g><g class="message" data-participant-1="ConsensusEngine" data-participant-2="ConsensusEngine"><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="352.4902" y1="181.7305" y2="181.7305"/><line style="stroke:#181818;stroke-width:1;" x1="352.4902" x2="352.4902" y1="181.7305" y2="194.7305"/><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="352.4902" y1="194.7305" y2="194.7305"/><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="194.7305" y2="190.7305"/><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="194.7305" y2="198.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="174.5859" x="317.4902" y="176.9883">Broadcast NewBatch (async)</text></g><g class="message" data-participant-1="ConsensusEngine" data-participant-2="ConsensusEngine"><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="352.4902" y1="224.041" y2="224.041"/><line style="stroke:#181818;stroke-width:1;" x1="352.4902" x2="352.4902" y1="224.041" y2="237.041"/><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="352.4902" y1="237.041" y2="237.041"/><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="237.041" y2="233.041"/><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="237.041" y2="241.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140.7212" x="317.4902" y="219.2988">Start consensus phase</text></g><g class="message" data-participant-1="ConsensusEngine" data-participant-2="ConsensusEngine"><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="352.4902" y1="266.3516" y2="266.3516"/><line style="stroke:#181818;stroke-width:1;" x1="352.4902" x2="352.4902" y1="266.3516" y2="279.3516"/><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="352.4902" y1="279.3516" y2="279.3516"/><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="279.3516" y2="275.3516"/><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="279.3516" y2="283.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179.9053" x="317.4902" y="261.6094">Collect votes, reach decision</text></g><path d="M233.939,294.3516 L296.0776,294.3516 L296.0776,301.6621 L286.0776,311.6621 L233.939,311.6621 L233.939,294.3516" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="105.2422" style="stroke:#000000;stroke-width:1.5;" width="449.2275" x="233.939" y="294.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17.1387" x="248.939" y="307.9199">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="117.0308" x="311.0776" y="306.9863">[Decision = Commit]</text><g class="message" data-participant-1="ConsensusEngine" data-participant-2="StateMachine"><line style="stroke:#181818;stroke-width:1;" x1="519.02" x2="509.02" y1="332.9727" y2="328.9727"/><line style="stroke:#181818;stroke-width:1;" x1="519.02" x2="509.02" y1="332.9727" y2="336.9727"/><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="520.02" y1="332.9727" y2="332.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126.0708" x="317.4902" y="328.2305">process(commands)</text></g><g class="message" data-participant-1="StateMachine" data-participant-2="ConsensusEngine"><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="362.2832" y2="358.2832"/><line style="stroke:#181818;stroke-width:1;" x1="311.4902" x2="321.4902" y1="362.2832" y2="366.2832"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="310.4902" x2="520.02" y1="362.2832" y2="362.2832"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97.6841" x="327.4902" y="357.541">List&lt;R&gt; results</text></g><g class="message" data-participant-1="ConsensusEngine" data-participant-2="Persistence"><line style="stroke:#181818;stroke-width:1;" x1="626.0254" x2="616.0254" y1="391.5938" y2="387.5938"/><line style="stroke:#181818;stroke-width:1;" x1="626.0254" x2="616.0254" y1="391.5938" y2="395.5938"/><line style="stroke:#181818;stroke-width:1;" x1="310.4902" x2="627.0254" y1="391.5938" y2="391.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="241.9092" x="317.4902" y="386.8516">save(state, lastPhase, pendingBatches)</text></g><g class="message" data-participant-1="ConsensusEngine" data-participant-2="Client"><line style="stroke:#181818;stroke-width:1;" x1="32.7524" x2="42.7524" y1="427.9043" y2="423.9043"/><line style="stroke:#181818;stroke-width:1;" x1="32.7524" x2="42.7524" y1="427.9043" y2="431.9043"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="31.7524" x2="309.4902" y1="427.9043" y2="427.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205.061" x="48.7524" y="423.1621">Promise completes with List&lt;R&gt;</text></g><!--SRC=[ZL9HJiCm3FtFAVo5DccxG3NwiS474g09k819hJKYJQBOsxGBS02Eo4bmsqsKRKZDdsE_v-Td9ypYh4iO15RUKH2JXbynC0NUydtOk41_Sg-2Gazew_F4cZ8x5WgMZEb9vsLvHbK0fkGF4nkR1aF5K_Z-_89rZerZMZmgVl5IbkOCTOrdbKc5m1B5rh1tKglgdCcZk1WUgZ4KRndj1xnt33UGUX5ZWCiSiRB80i-qxnLCa0_1JiUWrS4iO4_Va6eSrtOLlIShi8j2F0CrG1jNP1tho0QzmDqnW5ijRXed1lHTKW-NMBIJMsB-NKg76jRChyavRajryDOB_zDgS1O5CEvemYtn3Bpwjsv7dq6YKBcmwPmaRQ_XXH-jWkweYjEvg8LDygHUzFi_wZ4_]--></g></svg>